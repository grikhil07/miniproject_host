{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Mental Health Status Prediction</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f0f2f5;
            background-image: url("{% static 'predictor/bg.jpg' %}");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
        }

        .card-container {
            background-color: rgba(255, 255, 255, 0.90);
            padding: 34px 36px;
            border-radius: 14px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.12);
            max-width: 1200px;
            width: 96%;
            text-align: center;
            backdrop-filter: blur(4px);
        }

        h1 {
            color: #34344b;
            margin-bottom: 20px;
            font-size: 2.1rem;
            font-weight: 700;
        }

        /* question block layout */
        .question-block {
            padding: 8px 10px;
            text-align: left;
        }
        .q-label-row {
            display:flex;
            justify-content:space-between;
            align-items:center;
            gap:12px;
            margin-bottom:8px;
        }
        .label-text {
            font-weight:600;
            color:#333;
            margin:0;
            font-size:0.96rem;
            line-height:1.15;
            word-break:break-word;
        }
        .value-display {
            font-weight:700;
            color:#0d6efd;
            white-space:nowrap;
            font-size:0.96rem;
        }

        /* slider */
        .form-range {
            width:100%;
            height:8px;
            background:#e9ecef;
            border-radius:8px;
            outline:none;
        }
        .form-range::-webkit-slider-thumb {
            -webkit-appearance:none;
            width:18px; height:18px;
            background:#0d6efd; border-radius:50%;
            border:2px solid #fff; box-shadow:0 0 6px rgba(13,110,253,0.25);
        }
        .form-range::-moz-range-thumb {
            width:18px; height:18px;
            background:#0d6efd; border-radius:50%;
            border:2px solid #fff; box-shadow:0 0 6px rgba(13,110,253,0.25);
        }

        .controls {
            margin-top:18px;
        }
        .btn-predict, .btn-reset {
            color:#fff;
            padding:12px 28px;
            border-radius:8px;
            border:0;
            font-size:1rem;
            cursor:pointer;
        }
        .btn-predict { background:#0d6efd; }
        .btn-reset { background:#6c757d; margin-left:12px; }
        .btn-predict:hover { background:#0b5ed7; }
        .btn-reset:hover { background:#5a6268; }

        .modal-header.normal { background-color: #28a745; color: white; }
        .modal-header.stressed { background-color: #ffc107; color: #333; }
        .modal-header.at-risk { background-color: #dc3545; color: white; }

        @media (max-width: 992px) {
            .card-container { padding: 26px; }
        }
    </style>
</head>
<body>
    <div class="card-container">
        <h1>Mental Health Status Prediction</h1>

        <form id="prediction-form" method="post" action="{% url 'predict' %}">
            {% csrf_token %}
            <div class="row g-3">

                <!-- Format: question text on left, current value on right, slider below -->

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_anxiety_level">How would you rate your anxiety level out of 5?</p>
                        <span id="value-id_anxiety_level" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_anxiety_level" name="anxiety_level" min="0" max="5" step="1" value="0" aria-labelledby="label_anxiety_level">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_self_esteem">How would you rate your self-esteem out of 5?</p>
                        <span id="value-id_self_esteem" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_self_esteem" name="self_esteem" min="0" max="5" step="1" value="0" aria-labelledby="label_self_esteem">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_mental_health_history">How would you rate your mental health history impact (if any) out of 5?</p>
                        <span id="value-id_mental_health_history" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_mental_health_history" name="mental_health_history" min="0" max="5" step="1" value="0" aria-labelledby="label_mental_health_history">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_depression">How would you rate your depression symptoms out of 5?</p>
                        <span id="value-id_depression" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_depression" name="depression" min="0" max="5" step="1" value="0" aria-labelledby="label_depression">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_headache">How often do you experience headaches (rate severity) out of 5?</p>
                        <span id="value-id_headache" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_headache" name="headache" min="0" max="5" step="1" value="0" aria-labelledby="label_headache">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_blood_pressure">How would you rate your blood pressure related issues out of 5?</p>
                        <span id="value-id_blood_pressure" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_blood_pressure" name="blood_pressure" min="0" max="5" step="1" value="0" aria-labelledby="label_blood_pressure">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_sleep_quality">How would you rate your sleep quality out of 5?</p>
                        <span id="value-id_sleep_quality" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_sleep_quality" name="sleep_quality" min="0" max="5" step="1" value="0" aria-labelledby="label_sleep_quality">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_breathing_problem">How severe are breathing problems (if any) out of 5?</p>
                        <span id="value-id_breathing_problem" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_breathing_problem" name="breathing_problem" min="0" max="5" step="1" value="0" aria-labelledby="label_breathing_problem">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_noise_level">How bothersome is noise in your environment out of 5?</p>
                        <span id="value-id_noise_level" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_noise_level" name="noise_level" min="0" max="5" step="1" value="0" aria-labelledby="label_noise_level">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_living_conditions">How do you rate your living conditions out of 5?</p>
                        <span id="value-id_living_conditions" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_living_conditions" name="living_conditions" min="0" max="5" step="1" value="0" aria-labelledby="label_living_conditions">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_safety">How safe do you feel in your environment out of 5?</p>
                        <span id="value-id_safety" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_safety" name="safety" min="0" max="5" step="1" value="0" aria-labelledby="label_safety">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_basic_needs">How well are your basic needs met (0–5)?</p>
                        <span id="value-id_basic_needs" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_basic_needs" name="basic_needs" min="0" max="5" step="1" value="0" aria-labelledby="label_basic_needs">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_academic_performance">How do you rate your academic performance out of 5?</p>
                        <span id="value-id_academic_performance" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_academic_performance" name="academic_performance" min="0" max="5" step="1" value="0" aria-labelledby="label_academic_performance">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_study_load">How do you rate your study load out of 5?</p>
                        <span id="value-id_study_load" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_study_load" name="study_load" min="0" max="5" step="1" value="0" aria-labelledby="label_study_load">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_teacher_student_relationship">How would you rate your teacher-student relationship out of 5?</p>
                        <span id="value-id_teacher_student_relationship" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_teacher_student_relationship" name="teacher_student_relationship" min="0" max="5" step="1" value="0" aria-labelledby="label_teacher_student_relationship">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_future_career_concerns">How worried are you about your future career (0–5)?</p>
                        <span id="value-id_future_career_concerns" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_future_career_concerns" name="future_career_concerns" min="0" max="5" step="1" value="0" aria-labelledby="label_future_career_concerns">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_social_support">How would you rate your social support out of 5?</p>
                        <span id="value-id_social_support" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_social_support" name="social_support" min="0" max="5" step="1" value="0" aria-labelledby="label_social_support">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_peer_pressure">How much peer pressure do you feel (0–5)?</p>
                        <span id="value-id_peer_pressure" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_peer_pressure" name="peer_pressure" min="0" max="5" step="1" value="0" aria-labelledby="label_peer_pressure">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_extracurricular_activities">How active are you in extracurricular activities (0–5)?</p>
                        <span id="value-id_extracurricular_activities" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_extracurricular_activities" name="extracurricular_activities" min="0" max="5" step="1" value="0" aria-labelledby="label_extracurricular_activities">
                </div>

                <div class="col-lg-3 col-md-6 col-sm-12 question-block">
                    <div class="q-label-row">
                        <p class="label-text" id="label_bullying">How much bullying (if any) do you experience (0–5)?</p>
                        <span id="value-id_bullying" class="value-display">0/5</span>
                    </div>
                    <input type="range" class="form-range" id="id_bullying" name="bullying" min="0" max="5" step="1" value="0" aria-labelledby="label_bullying">
                </div>

            </div>

            <div class="controls d-flex justify-content-center">
                <button type="submit" class="btn-predict btn">Get Prediction</button>
                <button type="button" class="btn-reset btn">Reset</button>
            </div>
        </form>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="predictionModal" tabindex="-1" aria-labelledby="predictionModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="predictionModalLabel">Prediction Result</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body-text"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // update each slider display as "X/Max"
        function initSliderDisplays() {
            const sliders = document.querySelectorAll('.form-range');
            sliders.forEach(slider => {
                const display = document.getElementById('value-' + slider.id);
                if (!display) return;
                const update = () => {
                    const outOf = slider.max ?? 5;
                    display.innerText = slider.value + '/' + outOf;
                };
                slider.addEventListener('input', update);
                update();
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            initSliderDisplays();

            // AJAX submit (falls back to normal submit if server doesn't return JSON)
            document.getElementById('prediction-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const form = e.target;
                const actionUrl = form.action && form.action.trim() !== '' ? form.action : window.location.href;

                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    const num = parseFloat(value);
                    data[key] = Number.isFinite(num) ? num : 0;
                });

                fetch(actionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                })
                .then(resp => resp.json().catch(() => { throw new Error('non-json'); }))
                .then(result => {
                    const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
                    const modalHeader = document.querySelector('.modal-header');
                    const modalBody = document.getElementById('modal-body-text');
                    const prediction = result.prediction;
                    modalHeader.classList.remove('normal','stressed','at-risk');

                    if (prediction === 'Normal') {
                        modalHeader.classList.add('normal');
                        modalBody.innerHTML = 'Your predicted stress level: <strong>Normal</strong>';
                    } else if (prediction === 'Stressed') {
                        modalHeader.classList.add('stressed');
                        modalBody.innerHTML = 'Your predicted stress level: <strong>Stressed</strong>';
                    } else if (prediction === 'At Risk') {
                        modalHeader.classList.add('at-risk');
                        modalBody.innerHTML = 'Your predicted stress level: <strong>At Risk</strong>';
                    } else {
                        modalBody.innerHTML = 'Prediction: <strong>' + String(prediction) + '</strong>';
                    }
                    modal.show();
                })
                .catch(err => {
                    if (err.message === 'non-json') { form.submit(); return; }
                    console.error(err);
                    const modal = new bootstrap.Modal(document.getElementById('predictionModal'));
                    const modalHeader = document.querySelector('.modal-header');
                    const modalBody = document.getElementById('modal-body-text');
                    modalHeader.classList.remove('normal','stressed','at-risk');
                    modalHeader.classList.add('at-risk');
                    modalBody.innerHTML = 'An error occurred while getting the prediction.';
                    modal.show();
                });
            });

            // Reset
            document.querySelector('.btn-reset').addEventListener('click', function() {
                const sliders = document.querySelectorAll('.form-range');
                sliders.forEach(slider => {
                    slider.value = slider.min ?? 0;
                    slider.dispatchEvent(new Event('input', { bubbles: true }));
                });
            });
        });
    </script>
</body>
</html>
